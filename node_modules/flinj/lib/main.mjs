import e from"fast-glob";const t=e=>{const t=e.map((e=>import(`file://${e}`)));return Promise.all(t)},s=await(async()=>{const s=await e("middlewares/*.js",{absolute:!0}),a=await t(s);return s.reduce(((e,t,s)=>{const r=t.split("/").pop().replace(".js",""),c=a[s].default;return e.set(r,(e=>async(t,s,a)=>{const{params:r,query:c}=t,n={params:r,query:c};try{const t=await e(n);if(!t)return a();const{status:r=200,body:c,headers:o={}}=t;s.status(r).set(o).send(c)}catch(e){console.log(e)}})(c)),e}),new Map)})(),a=[];s.forEach(((e,t)=>{t.endsWith(".global")&&a.push(e)}));const r=["get","post","put","delete"],c=async()=>{const c=await e("controllers/**/*.js",{absolute:!0}),n=await t(c);return c.reduce(((e,t,c)=>{const o=n[c];let[,l]=t.split("controllers");return l=l.replace(".js",""),l.endsWith("index")&&(l=l.slice(0,-5)),/\[[a-z]+\]/gi.test(l)&&(l=l.replace(/\[/g,":").replace(/\]/g,"")),(e=>e.includes("[...]"))(l)&&(l=l.replace("[...]","*")),Object.entries(o).forEach((([t,c])=>{let n=t;if("del"===n&&(n="delete"),!r.includes(n))return;const{middlewares:u}=o,i=((e=[],t)=>{const r=[...a];return e.forEach((e=>{let a=e;if(e.includes(":")){let s=e.split(":");if(a=s[1],!s[0].split(",").includes(t))return}s.has(a)&&r.push(s.get(a))})),r})(u,t),d={method:n,route:l,handler:(p=c,async(e,t,s)=>{const{params:a,query:r}=e,c={params:a,query:r};try{const e=await p(c),{status:s=200,headers:a={}}=e||{};let{body:r={}}=e||{};if("object"==typeof r){const e={success:!0};Object.keys(r).length>0&&(e.data=r),r=e}t.status(s).set(a).send(r)}catch(e){t.status(500).json({success:!1,message:e.message})}}),middlewares:i};var p;e.push(d)})),e}),[])};export{c as generateControllers};
